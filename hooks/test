#!/bin/bash -xe

if [ "$SOURCE_BRANCH" = "master" ]; then exit 0; fi

trap "echo Exited!; exit;" SIGINT SIGTERM

export CONTAINER="ispconfig-test"

function buildAndTest() {
  YML=$1
  ARG=$2
  CMD="docker-compose -f test/$YML build --progress=plain $ARG"
  if ! $CMD | sed 's/\x1B\[[0-9;]*[JKmsu]//g' 2>&1; then
    echo "Failed: \"$CMD\""
    exit 1
  fi

  DOWN="docker-compose -f test/$YML down -v"
  CMD="docker-compose -f test/$YML up --abort-on-container-exit --force-recreate --remove-orphans sut"
  if time $CMD; then
    time $DOWN || true
  else
    echo "Failed: \"$CMD\""
    exit 1
  fi
}

function cleanImage() {
    docker image rmi "$CONTAINER" 2> /dev/null || true
}

function testNormal() {
  for F in puppeteer puppeteer.no-phpmyadmin bats bats.custom-ssl bats.reconfigure; do
    buildAndTest "docker-compose.$F.test.yml"
  done
}

function testLiveDB() {
  function databaseUp() {
    docker-compose -f "test/$1" up -d -V --force-recreate --remove-orphans mariadb
  }
  function databaseDown() {
    docker stop mariadb || true
    docker rm mariadb || true
  }

  cleanImage
  time databaseUp "$1"
  buildAndTest "$1"
  time databaseDown "$1"
  cleanImage
}

testNormal

echo "$(tput bold)=> Tests succeeded! $(tput sgr0)"
